<!doctype html><html dir=ltr lang=en data-theme=light><head><title>artis24106
|
2020 AIS3 EOF Final - Extensive Flag Checker</title><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="真白な夢 羽ばたかせよう"><link rel=stylesheet href=/blog/css/main.min.f08dfd6292604273495f670c5af67081690e166c26708b1dda2d9147b11b7fd9.css integrity="sha256-8I39YpJgQnNJX2cMWvZwgWkOFmwmcIsd2i2RR7Ebf9k=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/css/markupHighlight.min.cc84ed683057cc175ddfa738ea6ba2d5c882b95cb64f50bf9be918cb3791887b.css integrity="sha256-zITtaDBXzBdd36c46mui1ciCuVy2T1C/m+kYyzeRiHs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/css/custom.min.482d9951615a39324e608f92af5a5ddc467ab6b65ab73d6a748d39cdf7f2e321.css integrity="sha256-SC2ZUWFaOTJOYI+Sr1pd3EZ6trZatz1qdI05zffy4yE=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/blogfavicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/blogapple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/blogfavicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blogfavicon-16x16.png><link rel=canonical href=/blog/posts/2020-ais3-eof-final/exflagchecker/><script type=text/javascript src=/blog/js/anatole-header.min.413f798d8aa82610bef17a5ca1d7e962ec185be395f1aeb3f45d1891af568b65.js integrity="sha256-QT95jYqoJhC+8XpcodfpYuwYW+OV8a6z9F0Yka9Wi2U=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="2020 AIS3 EOF Final - Extensive Flag Checker"><meta name=twitter:description content="題目：Extensive Flag Checker
2020 AIS3 EOF Final 的最後一題啦"><script async src="https://www.googletagmanager.com/gtag/js?id=G-0K535799NY"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-0K535799NY');</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"2020 AIS3 EOF Final - Extensive Flag Checker","headline":"2020 AIS3 EOF Final - Extensive Flag Checker","alternativeHeadline":"","description":"
      
        \x3cp\x3e題目：\x3ccode\x3eExtensive Flag Checker\x3c\/code\x3e\x3c\/p\x3e\n\x3cp\x3e2020 AIS3 EOF Final 的最後一題啦\x3c\/p\x3e


      


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/artis24106.github.io\/blog\/posts\/2020-ais3-eof-final\/exflagchecker\/"},"author":{"@type":"Person","name":"artis24106"},"creator":{"@type":"Person","name":"artis24106"},"accountablePerson":{"@type":"Person","name":"artis24106"},"copyrightHolder":{"@type":"Person","name":"artis24106"},"copyrightYear":"2021","dateCreated":"2021-08-26T19:31:37.00Z","datePublished":"2021-08-26T19:31:37.00Z","dateModified":"2021-08-26T19:31:37.00Z","publisher":{"@type":"Organization","name":"artis24106","url":"https://artis24106.github.io/blog","logo":{"@type":"ImageObject","url":"https:\/\/artis24106.github.io\/blogfavicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/artis24106.github.io\/blog\/posts\/2020-ais3-eof-final\/exflagchecker\/","wordCount":"354","genre":["CTF"],"keywords":["CTF","AIS3","Reverse"]}</script></head><body><header><div class="page-top
."><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><nav><ul class=nav__list id=navMenu><div class=nav__links><li><a href=/blog/posts/>Posts</a></li><li><a href=/blog/tags/>Tags</a></li><li><a href=/blog/categories/>Categories</a></li></div><li></li></ul></nav></div></header><div class=wrapper><aside><div class="sidebar
."><div class=sidebar__content><div class=logo-title><div class=title><img src="https://avatars.githubusercontent.com/u/32833063?v=4" alt="profile picture"><h3><a href=/blog>artis24106's blog</a></h3><div class=description><p>真白な夢 羽ばたかせよう</p></div></div></div><ul class=social-links><li><a href=https://github.com/Artis24106 rel=me aria-label=Github><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer--sidebar"><div class=by_farbox><ul class=footer__list><li class=footer__item>&copy;
artis24106
2022</li></ul></div></footer><script type=text/javascript src=/blog/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js integrity="sha256-vceyOv9jSXp5Qzs5ILA+JHM5nZCtTC2Hz3wI0z1hlm8=" crossorigin=anonymous></script></div></aside><main><div class=autopagerize_page_element><div class=content><div class="post
."><div class=post-content><div class=post-title><h1>2020 AIS3 EOF Final - Extensive Flag Checker</h1><div class=info><em class="fas fa-calendar-day"></em><span class=date>Thu, Aug 26, 2021</span>
<em class="fas fa-stopwatch"></em><span class=reading-time>2-minute read</span></div></div><p>題目：<code>Extensive Flag Checker</code></p><p>2020 AIS3 EOF Final 的最後一題啦</p><h2 id=extensive-flag-checker-350>Extensive Flag Checker (350)</h2><h3 id=challenge-info>Challenge Info</h3><blockquote><p>I found a flag checker from my grandma’s computer. Can you check it for me?</p><p>Download: <a href="https://drive.google.com/file/d/1S3ZQsug3-KtX_Ob-J0jH7GZA-xUXF47p/view?usp=sharing">https://drive.google.com/file/d/1S3ZQsug3-KtX_Ob-J0jH7GZA-xUXF47p/view?usp=sharing</a>
(de-compress password: notinfected)</p><p>Author: Inndy</p></blockquote><p><code>ExtensiveFlagChecker.exe</code></p><h3 id=solution>Solution</h3><p>實際執行，是個有 GUI 的 flag checker</p><p>輸入框在很下面，螢幕不夠大會看不到XD，需要的話可以把它移上面一點</p><p><img src=img/1.png alt></p><p>.Net 老樣子丟 dnSpy，排除掉假 flag 跟明顯不可能的 hash 檢查，能追到一個 <code>check</code> function</p><p><img src=img/2.png alt></p><p>它會先把使用者輸入寫進 <code>"C:\\Windows\\Temp\\flag.txt"</code>，然後呼叫 <code>CreateThread</code> 執行 <code>Resources</code> 中的 shellcode（<code>native_checker</code>）</p><p><img src=img/3.png alt></p><p>shellcode 首先會做 decode（self modifying），對當前執行的 instruction 後面的所有內容 <code>^</code>, <code>+</code> 或 <code>-</code> 一個定值，總共 200 次，最後停在 <code>base + 0x19c8</code>（可以設定一個硬體斷點）</p><p>不想寫手動 decode 腳本，我的作法是用 x64dbg 先斷在 <code>CreateThread</code>，然後手動改 RIP 跳進 shellcode，再 F9 讓程式爛掉，就可以把完整的 shellcode dump 出來（不知道有沒有更好的方法）</p><p>decode 完之後會去爬 <code>ntdll.dll</code> 呼叫一些函式（沒仔細追XD），總之是把 <code>"C:\\Windows\\Temp\\flag.txt"</code> 讀進來</p><p>接下來是取輸入的 3 bytes 出來做 hash 然後檢查，總共 43 次（最後一次明顯是 <code>\x00</code> 不重要）</p><p><img src=img/4.png alt></p><p>3 bytes 所以輕鬆爆破，寫腳本搞定：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>string</span> <span class=kn>import</span> <span class=n>printable</span>
<span class=kn>from</span> <span class=nn>itertools</span> <span class=kn>import</span> <span class=n>product</span>

<span class=n>hash_list</span> <span class=o>=</span> <span class=p>[</span><span class=mh>0x3e40cb2f</span><span class=p>,</span> <span class=mh>0xcc03266</span><span class=p>,</span> <span class=mh>0xea7c6b98</span><span class=p>,</span> <span class=mh>0xbcbb5310</span><span class=p>,</span> <span class=mh>0xe9ea9a7f</span><span class=p>,</span> <span class=mh>0x293f1b89</span><span class=p>,</span> <span class=mh>0x3e82fdc7</span><span class=p>,</span> <span class=mh>0x3cc88b88</span><span class=p>,</span> <span class=mh>0x7e5f0a67</span><span class=p>,</span> <span class=mh>0xbf8a3407</span><span class=p>,</span> <span class=mh>0x6c2789c7</span><span class=p>,</span> <span class=mh>0x5459d1df</span><span class=p>,</span> <span class=mh>0xa26a4014</span><span class=p>,</span> <span class=mh>0x7f9ec0d2</span><span class=p>,</span> <span class=mh>0xde72e2db</span><span class=p>,</span> <span class=mh>0xa5db9645</span><span class=p>,</span> <span class=mh>0x2bc37848</span><span class=p>,</span> <span class=mh>0x7f6f3d0a</span><span class=p>,</span> <span class=mh>0x981ddff2</span><span class=p>,</span> <span class=mh>0x5484ed19</span><span class=p>,</span> <span class=mh>0x8676c0</span><span class=p>,</span>
             <span class=mh>0x6869caa9</span><span class=p>,</span> <span class=mh>0x55be7aa8</span><span class=p>,</span> <span class=mh>0xbb97a7ed</span><span class=p>,</span> <span class=mh>0x972791be</span><span class=p>,</span> <span class=mh>0xd4213c70</span><span class=p>,</span> <span class=mh>0x38baafd</span><span class=p>,</span> <span class=mh>0x15b2ca0e</span><span class=p>,</span> <span class=mh>0xc81e938d</span><span class=p>,</span> <span class=mh>0xc1497e5f</span><span class=p>,</span> <span class=mh>0xd7a8eef4</span><span class=p>,</span> <span class=mh>0x45080959</span><span class=p>,</span> <span class=mh>0x39d213c6</span><span class=p>,</span> <span class=mh>0xdbe05299</span><span class=p>,</span> <span class=mh>0xa3564671</span><span class=p>,</span> <span class=mh>0x17d4f44d</span><span class=p>,</span> <span class=mh>0x9d0369f</span><span class=p>,</span> <span class=mh>0x126b772f</span><span class=p>,</span> <span class=mh>0xbcbb5310</span><span class=p>,</span> <span class=mh>0x2fbe9d56</span><span class=p>,</span> <span class=mh>0x5484ed19</span><span class=p>,</span> <span class=mh>0xb5c06f98</span><span class=p>]</span>
<span class=n>hash_set</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>hash_list</span><span class=p>)</span>
<span class=n>hash_dict</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>

<span class=n>X32_UINT_MAX</span> <span class=o>=</span> <span class=mh>0x100000000</span>


<span class=k>def</span> <span class=nf>x32_uint</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>a</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>x32_uint</span><span class=p>(</span><span class=n>a</span> <span class=o>+</span> <span class=n>X32_UINT_MAX</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>a</span> <span class=o>&gt;=</span> <span class=n>X32_UINT_MAX</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>x32_uint</span><span class=p>(</span><span class=n>a</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>X32_UINT_MAX</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
    <span class=k>return</span> <span class=n>a</span>


<span class=k>def</span> <span class=nf>mul</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>x32_uint</span><span class=p>(</span><span class=n>a</span> <span class=o>*</span> <span class=n>b</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>minus</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>x32_uint</span><span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=n>b</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>xor</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>x32_uint</span><span class=p>(</span><span class=n>a</span> <span class=o>^</span> <span class=n>b</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>gen_flag</span><span class=p>():</span>
    <span class=n>flag</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
    <span class=k>for</span> <span class=n>h</span> <span class=ow>in</span> <span class=n>hash_list</span><span class=p>:</span>
        <span class=n>flag</span> <span class=o>+=</span> <span class=n>hash_dict</span><span class=p>[</span><span class=n>h</span><span class=p>]</span> <span class=k>if</span> <span class=n>h</span> <span class=ow>in</span> <span class=n>hash_dict</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span> <span class=k>else</span> <span class=s1>&#39;___&#39;</span>
    <span class=k>return</span> <span class=n>flag</span>


<span class=k>def</span> <span class=nf>hash</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
    <span class=n>cksm</span> <span class=o>=</span> <span class=mi>1</span>
    <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
        <span class=n>cksm</span> <span class=o>=</span> <span class=n>mul</span><span class=p>(</span><span class=mh>0x314159</span><span class=p>,</span> <span class=n>minus</span><span class=p>(</span><span class=n>cksm</span><span class=p>,</span> <span class=nb>ord</span><span class=p>(</span><span class=n>d</span><span class=p>)))</span>
        <span class=n>cksm</span> <span class=o>=</span> <span class=n>xor</span><span class=p>(</span><span class=n>cksm</span><span class=p>,</span> <span class=n>cksm</span> <span class=o>&gt;&gt;</span> <span class=mi>3</span><span class=p>)</span>
    <span class=n>cksm</span> <span class=o>-=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
    <span class=k>if</span> <span class=n>cksm</span> <span class=ow>in</span> <span class=n>hash_set</span><span class=p>:</span>
        <span class=n>hash_dict</span><span class=p>[</span><span class=n>cksm</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;[+] Found: {hex(cksm)}</span><span class=se>\t</span><span class=s2>&#39;{hash_dict[cksm]}&#39;</span><span class=se>\t</span><span class=s2>&#39;{gen_flag()}&#39;&#34;</span><span class=p>)</span>


<span class=k>for</span> <span class=n>el</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=n>printable</span><span class=p>,</span> <span class=n>repeat</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
    <span class=nb>hash</span><span class=p>(</span><span class=n>el</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>hash_dict</span><span class=p>)</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=n>hash_set</span><span class=p>):</span>
        <span class=k>break</span>
</code></pre></td></tr></table></div></div><p><img src=img/5.png alt></p><h3 id=flag>Flag</h3><p><code>AIS3{So you had some skill about reverse windows shellcode. Contact inndy.lin@cycarrier.com for an internship if you like. :D}</code></p><blockquote><p>其實 ARAY4 還比較難（麻煩）一些，為什麼當初沒有解出來QQ</p></blockquote></div><div class=post-footer><div class=info><span class=separator><a class=category href=/blog/categories/ctf/>CTF</a></span>
<span class=separator><a class=tag href=/blog/tags/ctf/>CTF</a><a class=tag href=/blog/tags/ais3/>AIS3</a><a class=tag href=/blog/tags/reverse/>Reverse</a></span></div></div><div id=fb_comments_container><h2>comments</h2><div id=gitalk-container></div><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.css integrity="sha512-0hsIlRjJbiUWaKMhXXNDmjWI2qPvUlhNBLHMhqeF5jIma+bedec27N5FoT2JEeHz5TUmOGCsm1Y89EsX/P0wOg==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js integrity="sha512-EcTCcXV46teiNwe0VcnM5A038tcY+BaQYO4nW6Gh2i7v4/HjBVg7xx3+JBLl9WofDds//INJAiEGAtdgr8PWyA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const gitalk=new Gitalk({clientID:'2ab39a69f03aa9ed4fa4',clientSecret:'177e45f7cb94b63a131778c57a72cd0a59798296',repo:'blog',owner:'artis24106',admin:['artis24106'],id:location.pathname,distractionFreeMode:false,});(function(){if(['localhost','127.0.0.1'].indexOf(window.location.hostname)!=-1){document.getElementById('gitalk-container').innerHTML='Gitalk comments not available by default when the website is previewed locally.';return;}
gitalk.render('gitalk-container');})();</script></div></div></div></div></main></div><footer class="footer footer--base"><div class=by_farbox><ul class=footer__list><li class=footer__item>&copy;
artis24106
2022</li></ul></div></footer><script type=text/javascript src=/blog/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js integrity="sha256-vceyOv9jSXp5Qzs5ILA+JHM5nZCtTC2Hz3wI0z1hlm8=" crossorigin=anonymous></script></body></html>