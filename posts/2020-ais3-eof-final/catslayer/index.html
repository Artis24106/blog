<!doctype html><html dir=ltr lang=en data-theme=light><head><title>artis24106
|
2020 AIS3 EOF final - ⚔ Cat Slayer ⚔</title><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="真白な夢 羽ばたかせよう"><link rel=stylesheet href=/blog/css/main.min.f08dfd6292604273495f670c5af67081690e166c26708b1dda2d9147b11b7fd9.css integrity="sha256-8I39YpJgQnNJX2cMWvZwgWkOFmwmcIsd2i2RR7Ebf9k=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/css/markupHighlight.min.cc84ed683057cc175ddfa738ea6ba2d5c882b95cb64f50bf9be918cb3791887b.css integrity="sha256-zITtaDBXzBdd36c46mui1ciCuVy2T1C/m+kYyzeRiHs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/css/custom.min.482d9951615a39324e608f92af5a5ddc467ab6b65ab73d6a748d39cdf7f2e321.css integrity="sha256-SC2ZUWFaOTJOYI+Sr1pd3EZ6trZatz1qdI05zffy4yE=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/blogfavicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/blogapple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/blogfavicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blogfavicon-16x16.png><link rel=canonical href=/blog/posts/2020-ais3-eof-final/catslayer/><script type=text/javascript src=/blog/js/anatole-header.min.413f798d8aa82610bef17a5ca1d7e962ec185be395f1aeb3f45d1891af568b65.js integrity="sha256-QT95jYqoJhC+8XpcodfpYuwYW+OV8a6z9F0Yka9Wi2U=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="2020 AIS3 EOF final - ⚔ Cat Slayer ⚔"><meta name=twitter:description content="題目：⚔ Cat Slayer ⚔"><script async src="https://www.googletagmanager.com/gtag/js?id=G-0K535799NY"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-0K535799NY');</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"2020 AIS3 EOF final - ⚔ Cat Slayer ⚔","headline":"2020 AIS3 EOF final - ⚔ Cat Slayer ⚔","alternativeHeadline":"","description":"
      
        \x3cp\x3e題目：\x3ccode\x3e⚔ Cat Slayer ⚔\x3c\/code\x3e\x3c\/p\x3e


      


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/artis24106.github.io\/blog\/posts\/2020-ais3-eof-final\/catslayer\/"},"author":{"@type":"Person","name":"artis24106"},"creator":{"@type":"Person","name":"artis24106"},"accountablePerson":{"@type":"Person","name":"artis24106"},"copyrightHolder":{"@type":"Person","name":"artis24106"},"copyrightYear":"2021","dateCreated":"2021-03-30T23:41:19.00Z","datePublished":"2021-03-30T23:41:19.00Z","dateModified":"2021-03-30T23:41:19.00Z","publisher":{"@type":"Organization","name":"artis24106","url":"https://artis24106.github.io/blog","logo":{"@type":"ImageObject","url":"https:\/\/artis24106.github.io\/blogfavicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/artis24106.github.io\/blog\/posts\/2020-ais3-eof-final\/catslayer\/","wordCount":"2523","genre":["CTF"],"keywords":["CTF","AIS3","Reverse"]}</script></head><body><header><div class="page-top
."><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><nav><ul class=nav__list id=navMenu><div class=nav__links><li><a href=/blog/posts/>Posts</a></li><li><a href=/blog/tags/>Tags</a></li><li><a href=/blog/categories/>Categories</a></li></div><li></li></ul></nav></div></header><div class=wrapper><aside><div class="sidebar
."><div class=sidebar__content><div class=logo-title><div class=title><img src="https://avatars.githubusercontent.com/u/32833063?v=4" alt="profile picture"><h3><a href=/blog>artis24106's blog</a></h3><div class=description><p>真白な夢 羽ばたかせよう</p></div></div></div><ul class=social-links><li><a href=https://github.com/Artis24106 rel=me aria-label=Github><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer--sidebar"><div class=by_farbox><ul class=footer__list><li class=footer__item>&copy;
artis24106
2022</li></ul></div></footer><script type=text/javascript src=/blog/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js integrity="sha256-vceyOv9jSXp5Qzs5ILA+JHM5nZCtTC2Hz3wI0z1hlm8=" crossorigin=anonymous></script></div></aside><main><div class=autopagerize_page_element><div class=content><div class="post
."><div class=post-content><div class=post-title><h1>2020 AIS3 EOF final - ⚔ Cat Slayer ⚔</h1><div class=info><em class="fas fa-calendar-day"></em><span class=date>Tue, Mar 30, 2021</span>
<em class="fas fa-stopwatch"></em><span class=reading-time>12-minute read</span></div></div><p>題目：<code>⚔ Cat Slayer ⚔</code></p><h2 id=-cat-slayer->⚔ Cat Slayer ⚔</h2><h3 id=challenge-info>Challenge Info</h3><blockquote><p>三十七年前，我只是某個隨處可見、普通的男高中生。</p><p>在十八歲生日前的那天放學，我一如往常地走在那條有些不平整的人行道上，然而一回神，我就被迎面衝來的兩百二十二隻貓咪撞暈了過去——再睜開眼，便來到這個異世界了。</p><p>&mldr;（字太多以下略XD）</p><p>Author: splitline</p></blockquote><p><code>game.pyc</code>, <code>cat_slayer.data.meow</code></p><h3 id=solution>Solution</h3><h4 id=part-0-try>Part 0: Try</h4><p>執行 <code>game.pyc</code>，是一個選單打怪小遊戲，並且錢夠多可以買 Flag</p><p><img src=img/1.png alt></p><p>看到 <code>.pyc</code> 就會想反編譯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>uncompyle6 game.pyc &gt; game.py
</code></pre></td></tr></table></div></div><p>看起來一切順利：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># uncompyle6 version 3.7.4</span>
<span class=c1># Python bytecode 3.8 (3413)</span>
<span class=c1># Decompiled from: Python 3.8.5 (default, Jul 28 2020, 12:59:40) </span>
<span class=c1># [GCC 9.3.0]</span>
<span class=c1># Embedded file name: source.py</span>
<span class=c1># Compiled at: 2021-02-03 03:35:27</span>
<span class=c1># Size of source mod 2**32: 1 bytes</span>
<span class=kn>import</span> <span class=nn>random</span><span class=o>,</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>struct</span>
<span class=n>hp</span> <span class=o>=</span> <span class=mi>1000</span>
<span class=n>attk</span> <span class=o>=</span> <span class=mi>10</span>
<span class=n>defs</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>money</span> <span class=o>=</span> <span class=mi>0</span>
<span class=n>token</span> <span class=o>=</span> <span class=bp>None</span>
<span class=n>GAME_OS</span> <span class=o>=</span> <span class=s1>&#39;Linux&#39;</span>
<span class=n>GAME_DATA_HEADER</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;___GAME_CAT_SLAYER_SAVED_DATA___&#39;</span>
<span class=n>GAME_DATA_PATH</span> <span class=o>=</span> <span class=s1>&#39;./cat_slayer.data&#39;</span>

<span class=k>def</span> <span class=nf>get_flag</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>token</span>
    <span class=k>if</span> <span class=n>token</span> <span class=o>!=</span> <span class=s1>&#39;d656d6f266c65637f236f62707f2&#39;</span><span class=p>:</span>
        <span class=k>return</span>
    <span class=n>magic</span> <span class=o>=</span> <span class=p>[</span><span class=mi>144</span><span class=p>,</span> <span class=mi>26</span><span class=p>,</span> <span class=mi>151</span><span class=p>,</span> <span class=mi>181</span><span class=p>,</span> <span class=mi>29</span><span class=p>,</span> <span class=mi>139</span><span class=p>,</span> <span class=mi>19</span><span class=p>,</span> <span class=mi>120</span><span class=p>,</span> <span class=mi>165</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>179</span><span class=p>,</span> <span class=mi>104</span><span class=p>,</span> <span class=mi>80</span><span class=p>,</span> <span class=mi>143</span><span class=p>]</span>
    <span class=n>fl4g</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>i</span> <span class=o>^</span> <span class=n>j</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>magic</span><span class=p>,</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>token</span><span class=p>))])</span>
    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;🐱 FLAG =&#39;</span><span class=p>,</span> <span class=n>fl4g</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>save_game</span><span class=p>(</span><span class=n>offset</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&gt;QQQQ&#39;</span><span class=p>,</span> <span class=n>hp</span><span class=p>,</span> <span class=n>attk</span><span class=p>,</span> <span class=n>defs</span><span class=p>,</span> <span class=n>money</span><span class=p>)):</span>
    <span class=k>global</span> <span class=n>GAME_DATA_PATH</span>
    <span class=k>global</span> <span class=n>money</span>
    <span class=k>global</span> <span class=n>token</span>
    <span class=k>if</span> <span class=n>token</span> <span class=o>==</span> <span class=s1>&#39;d656d6f266c65637f236f62707f2&#39;</span><span class=p>:</span>
        <span class=n>offset</span> <span class=o>+=</span> <span class=nb>id</span><span class=p>([</span><span class=o>*</span><span class=nb>globals</span><span class=p>()</span><span class=o>.</span><span class=n>values</span><span class=p>()][</span><span class=mi>23</span><span class=p>]</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_code</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>money</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>GAME_DATA_PATH</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>([</span><span class=o>*</span><span class=nb>globals</span><span class=p>()</span><span class=o>.</span><span class=n>values</span><span class=p>()][</span><span class=mi>17</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
            <span class=n>data</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;t</span><span class=se>\x13</span><span class=s1>d</span><span class=se>\x93</span><span class=s1>d</span><span class=se>\x94\x83\x02\x01\x00</span><span class=s1>q$&#39;</span>
            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>GAME_DATA_PATH</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>game_win_log</span><span class=p>):</span>
                <span class=n>game_win_log</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>GAME_DATA_HEADER</span><span class=p>)</span> <span class=o>+</span> <span class=nb>id</span><span class=p>([</span><span class=o>*</span><span class=nb>globals</span><span class=p>()</span><span class=o>.</span><span class=n>values</span><span class=p>()][</span><span class=mi>24</span><span class=p>]</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_code</span><span class=p>)</span> <span class=o>+</span> <span class=mi>240</span><span class=p>)</span>
                <span class=n>game_win_log</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&gt;HHHH&#39;</span><span class=p>,</span> <span class=mi>25626</span><span class=p>,</span> <span class=mi>24833</span><span class=p>,</span> <span class=mi>29707</span><span class=p>,</span> <span class=mi>33536</span><span class=p>))</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>GAME_DATA_PATH</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>f</span><span class=p>):</span>
        <span class=n>f</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>GAME_DATA_HEADER</span><span class=p>)</span> <span class=o>+</span> <span class=n>offset</span><span class=p>)</span>
        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>load_game</span><span class=p>(</span><span class=n>offset</span><span class=o>=</span><span class=n>GAME_DATA_HEADER</span><span class=o>.</span><span class=fm>__len__</span><span class=p>()):</span>
    <span class=k>global</span> <span class=n>attk</span>
    <span class=k>global</span> <span class=n>defs</span>
    <span class=k>global</span> <span class=n>hp</span>
    <span class=k>global</span> <span class=n>money</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>GAME_DATA_PATH</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>f</span><span class=p>):</span>
            <span class=n>f</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=n>offset</span><span class=p>)</span>
            <span class=n>hp</span><span class=p>,</span> <span class=n>attk</span><span class=p>,</span> <span class=n>defs</span><span class=p>,</span> <span class=n>money</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s1>&#39;&gt;QQQQ&#39;</span><span class=p>,</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()[:</span><span class=mi>32</span><span class=p>])</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>GAME_DATA_PATH</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>f</span><span class=p>):</span>
            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>GAME_DATA_HEADER</span><span class=p>)</span>
            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&gt;QQQQ&#39;</span><span class=p>,</span> <span class=n>hp</span><span class=p>,</span> <span class=n>attk</span><span class=p>,</span> <span class=n>defs</span><span class=p>,</span> <span class=n>money</span><span class=p>))</span>


<span class=k>def</span> <span class=nf>fight</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>hp</span>
    <span class=k>global</span> <span class=n>money</span>
    <span class=n>rounds</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x1b</span><span class=s1>c&#39;</span><span class=p>)</span>
    <span class=n>level</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Level [1,2,3,...]: &#39;</span><span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>level</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span> <span class=ow>or</span> <span class=nb>int</span><span class=p>(</span><span class=n>level</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>return</span>
    <span class=n>cat_power</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>level</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
    <span class=n>demon_names</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Buné&#39;</span><span class=p>,</span> <span class=s1>&#39;Samigina&#39;</span><span class=p>,</span> <span class=s1>&#39;Ronové&#39;</span><span class=p>,</span> <span class=s1>&#39;Vassago&#39;</span><span class=p>,</span> <span class=s1>&#39;Purson&#39;</span><span class=p>,</span> <span class=s1>&#39;Glasya-Labolas&#39;</span><span class=p>,</span> <span class=s1>&#39;Caim&#39;</span><span class=p>,</span> <span class=s1>&#39;Gremory&#39;</span><span class=p>,</span> <span class=s1>&#39;Vapula&#39;</span><span class=p>,</span> <span class=s1>&#39;Asmoday&#39;</span><span class=p>,</span> <span class=s1>&#39;Gäap&#39;</span><span class=p>,</span> <span class=s1>&#39;Furcas&#39;</span><span class=p>,</span> <span class=s1>&#39;Bifrons&#39;</span><span class=p>,</span> <span class=s1>&#39;Valac&#39;</span><span class=p>,</span> <span class=s1>&#39;Flauros&#39;</span><span class=p>,</span> <span class=s1>&#39;Alloces&#39;</span><span class=p>,</span> <span class=s1>&#39;Viné&#39;</span><span class=p>,</span> <span class=s1>&#39;Andromalius&#39;</span><span class=p>,</span> <span class=s1>&#39;Aim&#39;</span><span class=p>,</span> <span class=s1>&#39;Phenex&#39;</span><span class=p>,</span> <span class=s1>&#39;Agares&#39;</span><span class=p>,</span> <span class=s1>&#39;Malphas&#39;</span><span class=p>,</span> <span class=s1>&#39;Amdusias&#39;</span><span class=p>,</span> <span class=s1>&#39;Halphas&#39;</span><span class=p>,</span> <span class=s1>&#39;Dantalion&#39;</span><span class=p>,</span> <span class=s1>&#39;Astaroth&#39;</span><span class=p>,</span> <span class=s1>&#39;Marax&#39;</span><span class=p>,</span> <span class=s1>&#39;Focalor&#39;</span><span class=p>,</span> <span class=s1>&#39;Andras&#39;</span><span class=p>,</span> <span class=s1>&#39;Botis&#39;</span><span class=p>,</span> <span class=s1>&#39;Foras&#39;</span><span class=p>,</span> <span class=s1>&#39;Shax&#39;</span><span class=p>,</span> <span class=s1>&#39;Sabnock&#39;</span><span class=p>,</span> <span class=s1>&#39;Furfur&#39;</span><span class=p>,</span>
     <span class=s1>&#39;Amy&#39;</span><span class=p>,</span> <span class=s1>&#39;Marbas&#39;</span><span class=p>,</span> <span class=s1>&#39;Ose&#39;</span><span class=p>,</span> <span class=s1>&#39;Ipos&#39;</span><span class=p>,</span> <span class=s1>&#39;Orias&#39;</span><span class=p>,</span> <span class=s1>&#39;Amon&#39;</span><span class=p>,</span> <span class=s1>&#39;Zepar&#39;</span><span class=p>,</span> <span class=s1>&#39;Kimaris&#39;</span><span class=p>,</span> <span class=s1>&#39;Leraje&#39;</span><span class=p>,</span> <span class=s1>&#39;Bathin&#39;</span><span class=p>,</span> <span class=s1>&#39;Forneus&#39;</span><span class=p>,</span> <span class=s1>&#39;Buer&#39;</span><span class=p>,</span> <span class=s1>&#39;Murmur&#39;</span><span class=p>,</span> <span class=s1>&#39;Belial&#39;</span><span class=p>,</span> <span class=s1>&#39;Haagenti&#39;</span><span class=p>,</span> <span class=s1>&#39;Vual&#39;</span><span class=p>,</span> <span class=s1>&#39;Eligos&#39;</span><span class=p>,</span> <span class=s1>&#39;Naberius&#39;</span><span class=p>,</span> <span class=s1>&#39;Vepar&#39;</span><span class=p>,</span> <span class=s1>&#39;Beleth&#39;</span><span class=p>,</span> <span class=s1>&#39;Balam&#39;</span><span class=p>,</span> <span class=s1>&#39;Paimon&#39;</span><span class=p>,</span> <span class=s1>&#39;Sallos&#39;</span><span class=p>,</span> <span class=s1>&#39;Orobas&#39;</span><span class=p>,</span> <span class=s1>&#39;Seere&#39;</span><span class=p>,</span> <span class=s1>&#39;Barbatos&#39;</span><span class=p>,</span> <span class=s1>&#39;Bael&#39;</span><span class=p>,</span> <span class=s1>&#39;Valefor&#39;</span><span class=p>,</span> <span class=s1>&#39;Räum&#39;</span><span class=p>,</span> <span class=s1>&#39;Gusion&#39;</span><span class=p>,</span> <span class=s1>&#39;Crocell&#39;</span><span class=p>,</span> <span class=s1>&#39;Sitri&#39;</span><span class=p>,</span> <span class=s1>&#39;Berith&#39;</span><span class=p>,</span> <span class=s1>&#39;Stolas&#39;</span><span class=p>,</span> <span class=s1>&#39;Andrealphus&#39;</span><span class=p>,</span> <span class=s1>&#39;Zagan&#39;</span><span class=p>,</span> <span class=s1>&#39;Decarabia&#39;</span><span class=p>]</span>
    <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
        <span class=n>rounds</span> <span class=o>+=</span> <span class=mi>1</span>
        <span class=n>cat_name</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>demon_names</span><span class=p>)</span>
        <span class=n>cat_hp</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span> <span class=o>*</span> <span class=n>cat_power</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;+--------------------------------+&#39;</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;|&#39;</span> <span class=o>+</span> <span class=n>f</span><span class=s2>&#34;[Round {rounds}]&#34;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;|&#39;</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;|&#39;</span> <span class=o>+</span> <span class=n>f</span><span class=s2>&#34;Monster: Cat {cat_name}&#34;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;|&#39;</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;|&#39;</span> <span class=o>+</span> <span class=n>f</span><span class=s2>&#34;HP: {cat_hp}&#34;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;|&#39;</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;+--------------------------------+&#39;</span><span class=p>)</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>⚔ BATTLE START ⚔</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
        <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
            <span class=n>cat_attk</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span> <span class=o>*</span> <span class=n>cat_power</span>
            <span class=n>cat_defs</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>*</span> <span class=n>cat_power</span>
            <span class=n>damage</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>cat_attk</span> <span class=o>-</span> <span class=n>defs</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>level</span><span class=p>))</span>
            <span class=n>hp</span> <span class=o>-=</span> <span class=n>damage</span>
            <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Cat {cat_name} attacks you.&#34;</span><span class=p>)</span>
            <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Caused {damage} pts of damage. Your HP = {hp}.&#34;</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>hp</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
                <span class=k>print</span><span class=p>(</span><span class=s1>&#39;You died </span><span class=se>\\</span><span class=s1>|/.&#39;</span><span class=p>)</span>
                <span class=nb>exit</span><span class=p>()</span>
            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
            <span class=n>cat_damage</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>attk</span> <span class=o>-</span> <span class=n>cat_defs</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
            <span class=n>cat_hp</span> <span class=o>-=</span> <span class=n>cat_damage</span>
            <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;You attacks Cat {cat_name}.&#34;</span><span class=p>)</span>
            <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Caused {cat_damage} pts of damage. Cat&#39;s HP = {cat_hp}.&#34;</span><span class=p>)</span>
            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>cat_hp</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
                <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Cat {cat_name} died </span><span class=se>\\</span><span class=s2>|/.&#34;</span><span class=p>)</span>
                <span class=n>money</span> <span class=o>+=</span> <span class=n>cat_power</span> <span class=o>*</span> <span class=n>cat_power</span>
                <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;Drop some coins! [${cat_power * cat_power}]&#34;</span><span class=p>)</span>
                <span class=k>break</span>

        <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
            <span class=n>cont</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Next Cat (y/n): &#39;</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>cont</span> <span class=o>==</span> <span class=s1>&#39;y&#39;</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=k>elif</span> <span class=n>cont</span> <span class=o>==</span> <span class=s1>&#39;n&#39;</span><span class=p>:</span>
                <span class=k>return</span>


<span class=k>def</span> <span class=nf>shop</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>attk</span>
    <span class=k>global</span> <span class=n>defs</span>
    <span class=k>global</span> <span class=n>hp</span>
    <span class=k>global</span> <span class=n>money</span>
    <span class=k>global</span> <span class=n>token</span>
    <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
        <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;</span><span class=se>\x1b</span><span class=s2>c</span><span class=se>\n</span><span class=s2>[Shop]</span><span class=se>\n</span><span class=s2>========</span><span class=se>\n</span><span class=s2>Your Money = {money}</span><span class=se>\n</span><span class=s2>========</span><span class=se>\n</span><span class=s2>(H)P + 5 / $1</span><span class=se>\n</span><span class=s2>(A)ttack + 10 / $5</span><span class=se>\n</span><span class=s2>(D)efense + 10 / $5</span><span class=se>\n</span><span class=s2>(B)et / $100</span><span class=se>\n</span><span class=s2>(F)LAG / $2147483647</span><span class=se>\n</span><span class=s2>(S)ecret / $0</span><span class=se>\n</span><span class=s2>(Q)uit</span><span class=se>\n</span><span class=s2>    &#34;</span><span class=p>)</span>
        <span class=n>choose</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Choose: &#39;</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;H&#39;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>money</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>
                <span class=n>money</span> <span class=o>-=</span> <span class=mi>1</span>
                <span class=n>hp</span> <span class=o>+=</span> <span class=mi>5</span>
        <span class=k>if</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;A&#39;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>money</span> <span class=o>&gt;=</span> <span class=mi>5</span><span class=p>:</span>
                <span class=n>money</span> <span class=o>-=</span> <span class=mi>5</span>
                <span class=n>attk</span> <span class=o>+=</span> <span class=mi>10</span>
        <span class=k>if</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;D&#39;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>money</span> <span class=o>&gt;=</span> <span class=mi>5</span><span class=p>:</span>
                <span class=n>money</span> <span class=o>-=</span> <span class=mi>5</span>
                <span class=n>defs</span> <span class=o>+=</span> <span class=mi>10</span>
        <span class=k>if</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;B&#39;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>money</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>:</span>
                <span class=n>money</span> <span class=o>-=</span> <span class=mi>100</span>
                <span class=k>if</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>==</span> <span class=mi>999</span><span class=p>:</span>
                    <span class=n>money</span> <span class=o>=</span> <span class=mi>2147483647</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>money</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2147483647</span>
        <span class=k>if</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;F&#39;</span> <span class=ow>and</span> <span class=n>money</span> <span class=o>&gt;=</span> <span class=mi>2147483647</span><span class=p>:</span>
            <span class=n>money</span> <span class=o>-=</span> <span class=mi>2147483647</span>
            <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Meow, I am Cat Lucifer, you can also call me </span><span class=se>\x1b</span><span class=s1>[3mMaou</span><span class=se>\x1b</span><span class=s1>[23m 🐱&#39;</span><span class=p>)</span>
            <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;You beat all of us, we give up 🐱&#39;</span><span class=p>)</span>
            <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;So, here is your FLAG 🐱&#39;</span><span class=p>)</span>
            <span class=n>token</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;SECRET: &#39;</span><span class=p>)</span>
            <span class=n>get_flag</span><span class=p>()</span>
            <span class=k>print</span><span class=p>(</span><span class=s1>&#39;:) 🐱&#39;</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;S&#39;</span><span class=p>:</span>
            <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Meow, `d656d6f266c65637f236f62707f2`, you want this?&#39;</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;Q&#39;</span><span class=p>:</span>
            <span class=k>return</span>


<span class=k>def</span> <span class=nf>menu</span><span class=p>():</span>
    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x1b</span><span class=s1>c</span><span class=se>\n</span><span class=s1>[Menu]</span><span class=se>\n</span><span class=s1>========</span><span class=se>\n</span><span class=s1>(S)tatus</span><span class=se>\n</span><span class=s1>(F)ight</span><span class=se>\n</span><span class=s1>(B)uy</span><span class=se>\n</span><span class=s1>(L)oad / Save</span><span class=se>\n</span><span class=s1>(Q)uit</span><span class=se>\n</span><span class=s1>        &#39;</span><span class=p>)</span>
    <span class=k>return</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Choose: &#39;</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>game</span><span class=p>():</span>
    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x1b</span><span class=s1>c</span><span class=se>\n</span><span class=s1>   ______      __     _____ __                     </span><span class=se>\n</span><span class=s1>  / ____/___ _/ /_   / ___// /___ ___  _____  _____</span><span class=se>\n</span><span class=s1> / /   / __ `/ __/   </span><span class=se>\\</span><span class=s1>__ </span><span class=se>\\</span><span class=s1>/ / __ `/ / / / _ </span><span class=se>\\</span><span class=s1>/ ___/</span><span class=se>\n</span><span class=s1>/ /___/ /_/ / /_    ___/ / / /_/ / /_/ /  __/ /    </span><span class=se>\n\\</span><span class=s1>____/</span><span class=se>\\</span><span class=s1>__,_/</span><span class=se>\\</span><span class=s1>__/   /____/_/</span><span class=se>\\</span><span class=s1>__,_/</span><span class=se>\\</span><span class=s1>__, /</span><span class=se>\\</span><span class=s1>___/_/     </span><span class=se>\n</span><span class=s1>                                /____/             </span><span class=se>\n\n</span><span class=s1>            🐈 &lt;- THEY ARE EVIL Q_Q</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Name: &#39;</span><span class=p>)</span>
    <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
        <span class=n>choose</span> <span class=o>=</span> <span class=n>menu</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;S&#39;</span><span class=p>:</span>
            <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;</span><span class=se>\x1b</span><span class=s2>c</span><span class=se>\n</span><span class=s2>[Status]</span><span class=se>\n</span><span class=s2>========</span><span class=se>\n</span><span class=s2>Name: {name}</span><span class=se>\n</span><span class=s2>HP: {hp}</span><span class=se>\n</span><span class=s2>Attack: {attk}</span><span class=se>\n</span><span class=s2>Defense: {defs}</span><span class=se>\n</span><span class=s2>Money: {money}</span><span class=se>\n</span><span class=s2>                &#34;</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
            <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;=== PRESS ENTER TO CONTINUE ===&#39;</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;F&#39;</span><span class=p>:</span>
            <span class=n>fight</span><span class=p>()</span>
        <span class=k>elif</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;B&#39;</span><span class=p>:</span>
            <span class=n>shop</span><span class=p>()</span>
        <span class=k>elif</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;L&#39;</span><span class=p>:</span>
            <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Not implemented :/&#39;</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>choose</span> <span class=o>==</span> <span class=s1>&#39;Q&#39;</span><span class=p>:</span>
            <span class=k>break</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>uname</span><span class=p>()</span><span class=o>.</span><span class=n>sysname</span> <span class=o>!=</span> <span class=n>GAME_OS</span><span class=p>:</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;[x] Linux Only!&#39;</span><span class=p>)</span>
        <span class=nb>exit</span><span class=p>()</span>
    <span class=n>load_game</span><span class=p>()</span>
    <span class=n>game</span><span class=p>()</span>
<span class=c1># okay decompiling game.pyc</span>
</code></pre></td></tr></table></div></div><p>所以程式流程是：</p><ol><li>從 <code>'./cat_slayer.data'</code> 讀取資料，並且最後 8 bytes 用 big-endian 表示 <code>money</code></li><li>名字隨便打</li><li>直接買 Flag，並且輸入 token <code>d656d6f266c65637f236f62707f2</code></li><li>執行 <code>get_flag()</code> 並得到 flag</li></ol><p>換句話說，這是 flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>magic</span> <span class=o>=</span> <span class=p>[</span><span class=mi>144</span><span class=p>,</span> <span class=mi>26</span><span class=p>,</span> <span class=mi>151</span><span class=p>,</span> <span class=mi>181</span><span class=p>,</span> <span class=mi>29</span><span class=p>,</span> <span class=mi>139</span><span class=p>,</span> <span class=mi>19</span><span class=p>,</span> <span class=mi>120</span><span class=p>,</span> <span class=mi>165</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>179</span><span class=p>,</span> <span class=mi>104</span><span class=p>,</span> <span class=mi>80</span><span class=p>,</span> <span class=mi>143</span><span class=p>]</span>
<span class=n>fl4g</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>i</span> <span class=o>^</span> <span class=n>j</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>magic</span><span class=p>,</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>token</span><span class=p>))])</span>
<span class=k>print</span><span class=p>(</span><span class=s1>&#39;🐱 FLAG =&#39;</span><span class=p>,</span> <span class=n>fl4g</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>理想上輸出要是：<code>🐱 FLAG = b'FLAG{MEOWMEOW}'</code></p><p>但實際執行卻是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>
[REVENGE OF CATS]

 ██▀███  ▓█████ ██▒   █▓▓█████  ███▄    █   ▄████ ▓█████     ▒█████    █████▒    ▄████▄   ▄▄▄     ▄▄▄█████▓  ██████ 
▓██ ▒ ██▒▓█   ▀▓██░   █▒▓█   ▀  ██ ▀█   █  ██▒ ▀█▒▓█   ▀    ▒██▒  ██▒▓██   ▒    ▒██▀ ▀█  ▒████▄   ▓  ██▒ ▓▒▒██    ▒ 
▓██ ░▄█ ▒▒███   ▓██  █▒░▒███   ▓██  ▀█ ██▒▒██░▄▄▄░▒███      ▒██░  ██▒▒████ ░    ▒▓█    ▄ ▒██  ▀█▄ ▒ ▓██░ ▒░░ ▓██▄   
▒██▀▀█▄  ▒▓█  ▄  ▒██ █░░▒▓█  ▄ ▓██▒  ▐▌██▒░▓█  ██▓▒▓█  ▄    ▒██   ██░░▓█▒  ░    ▒▓▓▄ ▄██▒░██▄▄▄▄██░ ▓██▓ ░   ▒   ██▒
░██▓ ▒██▒░▒████▒  ▒▀█░  ░▒████▒▒██░   ▓██░░▒▓███▀▒░▒████▒   ░ ████▓▒░░▒█░       ▒ ▓███▀ ░ ▓█   ▓██▒ ▒██▒ ░ ▒██████▒▒
░ ▒▓ ░▒▓░░░ ▒░ ░  ░ ▐░  ░░ ▒░ ░░ ▒░   ▒ ▒  ░▒   ▒ ░░ ▒░ ░   ░ ▒░▒░▒░  ▒ ░       ░ ░▒ ▒  ░ ▒▒   ▓▒█░ ▒ ░░   ▒ ▒▓▒ ▒ ░
  ░▒ ░ ▒░ ░ ░  ░  ░ ░░   ░ ░  ░░ ░░   ░ ▒░  ░   ░  ░ ░  ░     ░ ▒ ▒░  ░           ░  ▒     ▒   ▒▒ ░   ░    ░ ░▒  ░ ░
  ░░   ░    ░       ░░     ░      ░   ░ ░ ░ ░   ░    ░      ░ ░ ░ ▒   ░ ░       ░          ░   ▒    ░      ░  ░  ░  
   ░        ░  ░     ░     ░  ░         ░       ░    ░  ░       ░ ░             ░ ░            ░  ░              ░  
                    ░                                                           ░                                   

[+] Encrypting: cat_slayer.data
Meow!
HP = 222
HP = 22
HP = 2
HP = 0
Meow, You Died \|/.
</code></pre></td></tr></table></div></div><h4 id=part-1long-function-name-qq>Part 1：Long function name QQ</h4><p>其實把 <code>.pyc</code> 的 bytecode 反組譯就能看出端倪：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>dis</span>
<span class=n>header_sizes</span> <span class=o>=</span> <span class=p>[(</span><span class=mi>8</span><span class=p>,</span>  <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>2</span><span class=p>)),</span> <span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>)),</span> <span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>7</span><span class=p>)),</span> <span class=p>]</span>
<span class=n>header_size</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>header_sizes</span><span class=p>)</span> <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>version_info</span> <span class=o>&gt;=</span> <span class=n>v</span><span class=p>)</span>

<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;game.pyc&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>metadata</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>header_size</span><span class=p>)</span> <span class=c1># header</span>
    <span class=n>m_code</span> <span class=o>=</span> <span class=n>marshal</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>       <span class=c1># code object</span>
<span class=n>dis</span><span class=o>.</span><span class=n>dis</span><span class=p>(</span><span class=n>m_code</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>會發現其中有一個 code object 長相特殊</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>...
Disassembly of &lt;code object get_flag():
    global token
    if token != &#39;d656d6f266c65637f236f62707f2&#39;:
        return
    magic = [144, 26, 151, 181, 29, 139, 19, 120, 165, 123, 179, 104, 80, 143]
    fl4g = bytes([i ^ j for i, j in zip(magic, bytes.fromhex(token))])
    print(&#39;🐱 FLAG =&#39;, fl4g)


def save_game at 0x7f3c0f07b9d0, file &#34;source.py&#34;, line 16&gt;:
 18           0 LOAD_GLOBAL              0 (token)
              2 LOAD_CONST               1 (&#39;d656d6f266c65637f236f62707f2&#39;)
              4 COMPARE_OP               2 (==)
              6 POP_JUMP_IF_FALSE      168

...
</code></pre></td></tr></table></div></div><p>也就是，事實上框起來的部分是 function name</p><p><img src=img/3.png alt></p><p>也就是 <code>get_flag()</code> 其實是執行「原本的」 <code>save_game()</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>get_flag</span><span class=p>(</span><span class=n>offset</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&gt;QQQQ&#39;</span><span class=p>,</span> <span class=n>hp</span><span class=p>,</span> <span class=n>attk</span><span class=p>,</span> <span class=n>defs</span><span class=p>,</span> <span class=n>money</span><span class=p>)):</span>
    <span class=k>global</span> <span class=n>GAME_DATA_PATH</span>
    <span class=k>global</span> <span class=n>money</span>
    <span class=k>global</span> <span class=n>token</span>
    <span class=k>if</span> <span class=n>token</span> <span class=o>==</span> <span class=s1>&#39;d656d6f266c65637f236f62707f2&#39;</span><span class=p>:</span>
        <span class=n>offset</span> <span class=o>+=</span> <span class=nb>id</span><span class=p>([</span><span class=o>*</span><span class=nb>globals</span><span class=p>()</span><span class=o>.</span><span class=n>values</span><span class=p>()][</span><span class=mi>23</span><span class=p>]</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_code</span><span class=p>)</span>  <span class=c1># fight()</span>
        <span class=k>if</span> <span class=n>money</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>GAME_DATA_PATH</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>([</span><span class=o>*</span><span class=nb>globals</span><span class=p>()</span><span class=o>.</span><span class=n>values</span><span class=p>()][</span><span class=mi>17</span><span class=p>][::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>  <span class=c1># b&#39;/proc/self/mem&#39;</span>
            <span class=n>data</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;t</span><span class=se>\x13</span><span class=s1>d</span><span class=se>\x93</span><span class=s1>d</span><span class=se>\x94\x83\x02\x01\x00</span><span class=s1>q$&#39;</span>
            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>GAME_DATA_PATH</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>game_win_log</span><span class=p>):</span>
                <span class=n>game_win_log</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>GAME_DATA_HEADER</span><span class=p>)</span> <span class=o>+</span>
                                  <span class=nb>id</span><span class=p>([</span><span class=o>*</span><span class=nb>globals</span><span class=p>()</span><span class=o>.</span><span class=n>values</span><span class=p>()][</span><span class=mi>24</span><span class=p>]</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_code</span><span class=p>)</span> <span class=o>+</span> <span class=mi>240</span><span class=p>)</span>  <span class=c1># shop() + 240</span>
                <span class=n>game_win_log</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&gt;HHHH&#39;</span><span class=p>,</span> <span class=mi>25626</span><span class=p>,</span> <span class=mi>24833</span><span class=p>,</span> <span class=mi>29707</span><span class=p>,</span> <span class=mi>33536</span><span class=p>))</span>
                <span class=s1>&#39;&#39;&#39;
</span><span class=s1>                0 LOAD_CONST              26 (-22222)
</span><span class=s1>                2 STORE_GLOBAL             1 (money)
</span><span class=s1>                4 LOAD_GLOBAL             11 (fight)
</span><span class=s1>                6 CALL_FUNCTION            0
</span><span class=s1>
</span><span class=s1>                money = -22222
</span><span class=s1>                fight()
</span><span class=s1>                &#39;&#39;&#39;</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>GAME_DATA_PATH</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>f</span><span class=p>):</span>
        <span class=n>f</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>GAME_DATA_HEADER</span><span class=p>)</span> <span class=o>+</span> <span class=n>offset</span><span class=p>)</span>  <span class=c1># fight() + offset</span>
        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>所以真正的執行流程是：</p><ol><li>執行 <code>get_flag()</code> 之後，修改 <code>/proc/self/mem</code>，也就是 self modifying</li><li>對 <code>shop() + 240</code> 的位置寫入 <code>struct.pack('>HHHH', 25626, 24833, 29707, 33536)</code></li><li>對 <code>fight() + offset</code> 的位置寫入 <code>b't\x13d\x93d\x94\x83\x02\x01\x00q$'</code></li></ol><h4 id=part-2disdis>Part 2：dis.dis()</h4><p>先分析 <code>shop() + 240</code> 的部分：</p><p>首先要知道 <code>shop() + 240</code> 在哪裡，用 <code>dis.dis()</code> 分析 <code>game.pyc</code> 內的 <code>shop()</code> code object</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>...</span>
<span class=mi>134</span>         <span class=mi>226</span> <span class=n>LOAD_GLOBAL</span>              <span class=mi>2</span> <span class=p>(</span><span class=nb>input</span><span class=p>)</span>
            <span class=mi>228</span> <span class=n>LOAD_CONST</span>              <span class=mi>21</span> <span class=p>(</span><span class=s1>&#39;SECRET: &#39;</span><span class=p>)</span>
            <span class=mi>230</span> <span class=n>CALL_FUNCTION</span>            <span class=mi>1</span>
            <span class=mi>232</span> <span class=n>STORE_GLOBAL</span>             <span class=mi>8</span> <span class=p>(</span><span class=n>token</span><span class=p>)</span>
            <span class=c1># token = input(&#39;SECRET: &#39;)</span>
            
<span class=mi>135</span>         <span class=mi>234</span> <span class=n>LOAD_GLOBAL</span>              <span class=mi>9</span> <span class=p>(</span><span class=n>get_flag</span><span class=p>)</span>
            <span class=mi>236</span> <span class=n>CALL_FUNCTION</span>            <span class=mi>0</span>
            <span class=mi>238</span> <span class=n>POP_TOP</span>
            <span class=c1># get_flag()</span>

<span class=mi>136</span>         <span class=mi>240</span> <span class=n>LOAD_GLOBAL</span>              <span class=mi>0</span> <span class=p>(</span><span class=k>print</span><span class=p>)</span>
            <span class=mi>242</span> <span class=n>LOAD_CONST</span>              <span class=mi>22</span> <span class=p>(</span><span class=s1>&#39;:) 🐱&#39;</span><span class=p>)</span>
            <span class=mi>244</span> <span class=n>CALL_FUNCTION</span>            <span class=mi>1</span>
            <span class=mi>246</span> <span class=n>POP_TOP</span>
            <span class=mi>248</span> <span class=n>JUMP_ABSOLUTE</span>            <span class=mi>0</span>
            <span class=c1># print(&#39;:) 🐱&#39;)</span>
<span class=o>...</span>
</code></pre></td></tr></table></div></div><p>也就是把 <code>print(':) 🐱')</code> 之後的內容蓋掉（<code>get_flag()</code> 結束後執行）</p><p>而覆蓋的 byte code 內容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>3</span><span class=p>]:</span> <span class=n>dis</span><span class=o>.</span><span class=n>dis</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&gt;HHHH&#39;</span><span class=p>,</span> <span class=mi>25626</span><span class=p>,</span> <span class=mi>24833</span><span class=p>,</span> <span class=mi>29707</span><span class=p>,</span> <span class=mi>33536</span><span class=p>))</span>                                                                           
          <span class=mi>0</span> <span class=n>LOAD_CONST</span>              <span class=mi>26</span> <span class=p>(</span><span class=mi>26</span><span class=p>)</span>
          <span class=mi>2</span> <span class=n>STORE_GLOBAL</span>             <span class=mi>1</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
          <span class=mi>4</span> <span class=n>LOAD_GLOBAL</span>             <span class=mi>11</span> <span class=p>(</span><span class=mi>11</span><span class=p>)</span>
          <span class=mi>6</span> <span class=n>CALL_FUNCTION</span>            <span class=mi>0</span>
</code></pre></td></tr></table></div></div><p>變數內容可以從 <code>shop()</code> byte code 的 <code>co_consts</code>, <code>co_names</code> 取得：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mi>0</span> <span class=n>LOAD_CONST</span>              <span class=mi>26</span> <span class=p>(</span><span class=o>-</span><span class=mi>22222</span><span class=p>)</span>
<span class=mi>2</span> <span class=n>STORE_GLOBAL</span>             <span class=mi>1</span> <span class=p>(</span><span class=n>money</span><span class=p>)</span>
<span class=mi>4</span> <span class=n>LOAD_GLOBAL</span>             <span class=mi>11</span> <span class=p>(</span><span class=n>fight</span><span class=p>)</span>
<span class=mi>6</span> <span class=n>CALL_FUNCTION</span>            <span class=mi>0</span>

<span class=c1># money = -22222</span>
<span class=c1># fight()</span>
</code></pre></td></tr></table></div></div><p>同理，寫到 <code>fight() + offset</code> 的內容也可以用同樣方式解出來</p><p>他會用有點遞迴的方式把 <code>fight()</code> 寫掉</p><ul><li>先蓋掉 <code>fight() + 0</code> 的部分</li><li>執行 <code>fight()</code> 之後會再寫掉 <code>fight() + 16</code>，並且跳進去</li><li>以此類推</li></ul><p>寫個腳本把所有 patch 的 instruction 印出來：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>dis</span>
<span class=kn>import</span> <span class=nn>marshal</span>
<span class=kn>import</span> <span class=nn>sys</span>
<span class=kn>from</span> <span class=nn>io</span> <span class=kn>import</span> <span class=n>StringIO</span>
<span class=kn>import</span> <span class=nn>re</span>
<span class=kn>import</span> <span class=nn>struct</span>

<span class=n>header_sizes</span> <span class=o>=</span> <span class=p>[(</span><span class=mi>8</span><span class=p>,</span>  <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>2</span><span class=p>)),</span> <span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>)),</span> <span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>7</span><span class=p>)),</span> <span class=p>]</span>
<span class=n>header_size</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>header_sizes</span><span class=p>)</span> <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>version_info</span> <span class=o>&gt;=</span> <span class=n>v</span><span class=p>)</span>

<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;game.pyc&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>metadata</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>header_size</span><span class=p>)</span>    <span class=c1># header</span>
    <span class=n>m_code</span> <span class=o>=</span> <span class=n>marshal</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>          <span class=c1># marshalled code object</span>

<span class=n>code</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=nb>compile</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;exec&#39;</span><span class=p>))</span>


<span class=k>def</span> <span class=nf>get_codeobject_index</span><span class=p>(</span><span class=n>func_name</span><span class=p>):</span>
    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>code</span><span class=p>)</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>co_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>func_name</span><span class=p>):</span>
            <span class=k>return</span> <span class=n>i</span>
        <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>


<span class=k>def</span> <span class=nf>get_dis</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
    <span class=k>with</span> <span class=n>StringIO</span><span class=p>()</span> <span class=k>as</span> <span class=n>out</span><span class=p>:</span>
        <span class=n>dis</span><span class=o>.</span><span class=n>dis</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>file</span><span class=o>=</span><span class=n>out</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>out</span><span class=o>.</span><span class=n>getvalue</span><span class=p>()</span>


<span class=k>def</span> <span class=nf>get_instruction</span><span class=p>(</span><span class=n>ins</span><span class=p>):</span>
    <span class=n>r</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;\d+ ([A-Z_]+) +\d+ \((\d+)\)&#34;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=n>ins</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>get_consts</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>[</span><span class=n>a</span><span class=p>]</span><span class=o>.</span><span class=n>co_consts</span><span class=p>[</span><span class=n>b</span><span class=p>]</span>


<span class=k>def</span> <span class=nf>get_global</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>[</span><span class=n>a</span><span class=p>]</span><span class=o>.</span><span class=n>co_names</span><span class=p>[</span><span class=n>b</span><span class=p>]</span>


<span class=k>def</span> <span class=nf>get_varnames</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>[</span><span class=n>a</span><span class=p>]</span><span class=o>.</span><span class=n>co_varnames</span><span class=p>[</span><span class=n>b</span><span class=p>]</span>


<span class=k>def</span> <span class=nf>fight_parser</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>ins</span><span class=p>):</span>
    <span class=n>byte_code_list</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>finish</span> <span class=o>=</span> <span class=bp>False</span>
    <span class=k>for</span> <span class=n>el</span> <span class=ow>in</span> <span class=n>get_instruction</span><span class=p>(</span><span class=n>ins</span><span class=p>):</span>
        <span class=n>ins_name</span> <span class=o>=</span> <span class=n>el</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>ins_arg</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>el</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
        <span class=n>res</span> <span class=o>=</span> <span class=bp>None</span>
        <span class=k>if</span> <span class=n>ins_name</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;LOAD_GLOBAL&#34;</span><span class=p>,</span> <span class=s2>&#34;LOAD_METHOD&#34;</span><span class=p>]:</span>
            <span class=n>res</span> <span class=o>=</span> <span class=n>get_global</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>ins_arg</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>ins_name</span> <span class=o>==</span> <span class=s2>&#34;LOAD_CONST&#34;</span><span class=p>:</span>
            <span class=n>res</span> <span class=o>=</span> <span class=n>get_consts</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>ins_arg</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>ins_name</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;LOAD_FAST&#34;</span><span class=p>,</span> <span class=s2>&#34;STORE_FAST&#34;</span><span class=p>]:</span>
            <span class=n>res</span> <span class=o>=</span> <span class=n>get_varnames</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>ins_arg</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>res</span> <span class=o>!=</span> <span class=bp>None</span><span class=p>:</span>
            <span class=n>ins</span> <span class=o>=</span> <span class=n>ins</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span>
                <span class=n>f</span><span class=s2>&#34;({ins_arg})&#34;</span><span class=p>,</span> <span class=n>f</span><span class=s2>&#34;({res})&#34;</span><span class=p>)</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>res</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>):</span>
                <span class=n>byte_code_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>res</span> <span class=o>==</span> <span class=s2>&#34;exit&#34;</span><span class=p>:</span>
                <span class=n>finish</span> <span class=o>=</span> <span class=bp>True</span>
    <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;{ins}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>finish</span><span class=p>:</span>
        <span class=k>return</span>
    <span class=k>for</span> <span class=n>bc</span> <span class=ow>in</span> <span class=n>byte_code_list</span><span class=p>:</span>
        <span class=n>fight_parser</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>get_dis</span><span class=p>(</span><span class=n>bc</span><span class=p>))</span>

<span class=s1>&#39;&#39;&#39;Parse&#39;&#39;&#39;</span>
<span class=n>idx</span> <span class=o>=</span> <span class=n>get_codeobject_index</span><span class=p>(</span><span class=s2>&#34;fight&#34;</span><span class=p>)</span>
<span class=n>data</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;t</span><span class=se>\x13</span><span class=s1>d</span><span class=se>\x93</span><span class=s1>d</span><span class=se>\x94\x83\x02\x01\x00</span><span class=s1>q$&#39;</span>
<span class=n>ins</span> <span class=o>=</span> <span class=n>get_dis</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>

<span class=n>fight_parser</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>ins</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>內容其實不多，所以手動把輸出的 instruction 轉換成 python code：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>fight</span><span class=p>():</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;[REVENGE OF CATS]...&#34;</span><span class=p>)</span>
    <span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()))</span>
    <span class=k>for</span> <span class=n>rounds</span> <span class=ow>in</span> <span class=nb>__import__</span><span class=p>(</span><span class=s1>&#39;glob&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s1>&#39;*.data&#39;</span><span class=p>):</span>
        <span class=k>print</span><span class=p>(</span><span class=s1>&#39;[+] Encrypting:&#39;</span><span class=p>,</span> <span class=n>rounds</span><span class=p>)</span>
        <span class=n>level</span> <span class=o>=</span> <span class=mi>8</span>
        <span class=n>cat_power</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>rounds</span> <span class=o>+</span> <span class=s2>&#34;.meow&#34;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>demon_names</span> <span class=ow>in</span> <span class=nb>open</span><span class=p>(</span><span class=n>rounds</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>():</span>
            <span class=n>cat_name</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>22</span><span class=p>,</span> <span class=mi>222</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>level</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>-</span> <span class=mi>5</span><span class=p>)</span> <span class=o>%</span> <span class=mi>22</span>
            <span class=n>cat_power</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>bytes</span><span class=p>([</span><span class=n>demon_names</span> <span class=o>^</span> <span class=n>cat_name</span><span class=p>]))</span>
            <span class=n>level</span> <span class=o>+=</span> <span class=mi>3</span>
        <span class=nb>__import__</span><span class=p>(</span><span class=s1>&#39;os&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>unlink</span><span class=p>(</span><span class=n>rounds</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Meow!</span><span class=se>\n</span><span class=s1>HP = 222&#39;</span><span class=p>)</span>
    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;HP = 22&#34;</span><span class=p>)</span>
    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;HP = 2&#34;</span><span class=p>)</span>
    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;HP = 0</span><span class=se>\n</span><span class=s2>Meow, You Died </span><span class=se>\\</span><span class=s2>|/.&#34;</span><span class=p>)</span>
    <span class=nb>exit</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><p>弱點明顯是 <code>random.seed(int(time.time()))</code></p><p>因為可以知道檔案創建時間，稍微爆破一下 timestamp 就能解出檔案內容</p><p><img src=img/2.png alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>random</span>
<span class=kn>import</span> <span class=nn>time</span>
<span class=kn>import</span> <span class=nn>dis</span>
<span class=kn>import</span> <span class=nn>datetime</span>

<span class=k>def</span> <span class=nf>dec</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>):</span>
    <span class=k>for</span> <span class=n>ts</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>timestamp</span><span class=p>)):</span>
        <span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=n>ts</span><span class=p>)</span>
        <span class=n>level</span> <span class=o>=</span> <span class=mi>8</span>
        <span class=n>flag</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
        <span class=k>for</span> <span class=n>demon_names</span> <span class=ow>in</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_name</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>():</span>
            <span class=n>cat_name</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>22</span><span class=p>,</span> <span class=mi>222</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>level</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>-</span> <span class=mi>5</span><span class=p>)</span> <span class=o>%</span> <span class=mi>22</span>
            <span class=n>flag</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>demon_names</span> <span class=o>^</span> <span class=n>cat_name</span><span class=p>)</span>
            <span class=n>level</span> <span class=o>+=</span> <span class=mi>3</span>
        <span class=k>if</span> <span class=s2>&#34;AIS3&#34;</span> <span class=ow>in</span> <span class=n>flag</span><span class=p>:</span>
            <span class=k>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
            <span class=k>return</span>


<span class=n>dec</span><span class=p>(</span><span class=s2>&#34;cat_slayer.data.meow.flag&#34;</span><span class=p>,</span> <span class=mi>1612294560</span><span class=p>)</span>  <span class=c1># 2020/02/03 3:36</span>
<span class=c1># ___GAME_CAT_SLAYER_SAVED_DATA___AIS3{d4rkness_c4ts_ar3_ev1l_qwq}</span>
</code></pre></td></tr></table></div></div><h3 id=flag>Flag</h3><p><code>AIS3{d4rkness_c4ts_ar3_ev1l_qwq}</code></p><blockquote><p>順手附上之前做的 pyc 簡報：<a href=https://hackmd.io/@C5qogZpXS6m0aedcVROJ6A/rkGBI_1ru#/>https://hackmd.io/@C5qogZpXS6m0aedcVROJ6A/rkGBI_1ru#/</a></p></blockquote><hr><h3 id=bonus>Bonus</h3><p>實際改改看 function name，讓 <code>uncompyle6</code> 反編譯出來的結果跟實際不同</p><p>先創建 <code>test.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>func1</span><span class=p>():</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&#34;this is func1()&#34;</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>func2</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
    <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;this is func2({a})&#34;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>a</span> <span class=o>*</span> <span class=mi>10</span>


<span class=n>func1</span><span class=p>()</span>
<span class=n>func2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>func2</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p><code>python3 -m compileall test.py -b</code> 得到 <code>test.pyc</code></p><p>寫個腳本 <code>patch.py</code> 將 <code>func2</code> 替換掉，也就是修改 <code>func2()</code> 的 <code>co_name</code> 再用 <code>marshal</code> 序列化存起來</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>marshal</span>
<span class=kn>import</span> <span class=nn>sys</span>

<span class=n>header_sizes</span> <span class=o>=</span> <span class=p>[(</span><span class=mi>8</span><span class=p>,</span>  <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>2</span><span class=p>)),</span> <span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>6</span><span class=p>)),</span> <span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>7</span><span class=p>)),</span> <span class=p>]</span>
<span class=n>header_size</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>header_sizes</span><span class=p>)</span> <span class=k>if</span> <span class=n>sys</span><span class=o>.</span><span class=n>version_info</span> <span class=o>&gt;=</span> <span class=n>v</span><span class=p>)</span>

<span class=s1>&#39;&#39;&#39;Get code object&#39;&#39;&#39;</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;test.pyc&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>metadata</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>header_size</span><span class=p>)</span>
    <span class=n>m_code</span> <span class=o>=</span> <span class=n>marshal</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>

<span class=s1>&#39;&#39;&#39;Get the index of func2() code object&#39;&#39;&#39;</span>
<span class=n>code</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=nb>compile</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;exec&#39;</span><span class=p>))</span>
<span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>:</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=n>code</span><span class=p>)</span> <span class=ow>and</span> <span class=n>c</span><span class=o>.</span><span class=n>co_name</span> <span class=o>==</span> <span class=s2>&#34;func2&#34;</span><span class=p>:</span>
        <span class=n>idx</span> <span class=o>=</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
        <span class=k>break</span>

<span class=s1>&#39;&#39;&#39;Patch co_name&#39;&#39;&#39;</span>
<span class=n>new_name</span> <span class=o>=</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>co_name</span> <span class=o>+</span> <span class=s1>&#39;&#39;&#39;(b):
</span><span class=s1>    print(&#34;我在這裡偷星爆一定沒人會發現&#34; * b)
</span><span class=s1>
</span><span class=s1>
</span><span class=s1>def 這不是很戲劇化的發展嗎&#39;&#39;&#39;</span>
<span class=n>tmp</span> <span class=o>=</span> <span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>co_name</span><span class=o>=</span><span class=n>new_name</span><span class=p>)</span>
<span class=n>lis</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>m_code</span><span class=o>.</span><span class=n>co_consts</span><span class=p>)</span>
<span class=n>lis</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>tmp</span>
<span class=n>new_consts</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>lis</span><span class=p>)</span>
<span class=n>m_code</span> <span class=o>=</span> <span class=n>m_code</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>co_consts</span><span class=o>=</span><span class=n>new_consts</span><span class=p>)</span>

<span class=s1>&#39;&#39;&#39;Write to new file&#39;&#39;&#39;</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;test_patched.pyc&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>metadata</span><span class=p>)</span>
    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>marshal</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>m_code</span><span class=p>))</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ python3 patch.py
$ uncompyle6 test_patched.pyc &gt; test_patched.py
</code></pre></td></tr></table></div></div><p>最後反編譯得到 <code>test_patched.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text># uncompyle6 version 3.7.4
# Python bytecode 3.8 (3413)
# Decompiled from: Python 3.8.5 (default, Jul 28 2020, 12:59:40) 
# [GCC 9.3.0]
# Embedded file name: test.py
# Compiled at: 2021-02-08 17:58:34
# Size of source mod 2**32: 137 bytes


def func1():
    print(&#39;this is func1()&#39;)


def func2(b):
    print(&#34;我在這裡偷星爆一定沒人發現&#34; * b)


def 這不是很戲劇化的發展嗎(a):
    print(f&#34;this is func2({a})&#34;)
    return a * 10


func1()
func2(1)
func2(3)
# okay decompiling test_patched.pyc
</code></pre></td></tr></table></div></div><p>成功！</p></div><div class=post-footer><div class=info><span class=separator><a class=category href=/blog/categories/ctf/>CTF</a></span>
<span class=separator><a class=tag href=/blog/tags/ctf/>CTF</a><a class=tag href=/blog/tags/ais3/>AIS3</a><a class=tag href=/blog/tags/reverse/>Reverse</a></span></div></div><div id=fb_comments_container><h2>comments</h2><div id=gitalk-container></div><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.css integrity="sha512-0hsIlRjJbiUWaKMhXXNDmjWI2qPvUlhNBLHMhqeF5jIma+bedec27N5FoT2JEeHz5TUmOGCsm1Y89EsX/P0wOg==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js integrity="sha512-EcTCcXV46teiNwe0VcnM5A038tcY+BaQYO4nW6Gh2i7v4/HjBVg7xx3+JBLl9WofDds//INJAiEGAtdgr8PWyA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const gitalk=new Gitalk({clientID:'2ab39a69f03aa9ed4fa4',clientSecret:'177e45f7cb94b63a131778c57a72cd0a59798296',repo:'blog',owner:'artis24106',admin:['artis24106'],id:location.pathname,distractionFreeMode:false,});(function(){if(['localhost','127.0.0.1'].indexOf(window.location.hostname)!=-1){document.getElementById('gitalk-container').innerHTML='Gitalk comments not available by default when the website is previewed locally.';return;}
gitalk.render('gitalk-container');})();</script></div></div></div></div></main></div><footer class="footer footer--base"><div class=by_farbox><ul class=footer__list><li class=footer__item>&copy;
artis24106
2022</li></ul></div></footer><script type=text/javascript src=/blog/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js integrity="sha256-vceyOv9jSXp5Qzs5ILA+JHM5nZCtTC2Hz3wI0z1hlm8=" crossorigin=anonymous></script></body></html>